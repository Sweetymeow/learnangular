<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="http://cdn.jsdelivr.net/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript">
        var geojsonData = [];
        //        var colors = d3.scale.category20();
        var geocodeKey = {
            url: 'https://maps.googleapis.com/maps/api/geocode/json?address=',
            address: '',
            nobias: 'location=0,0&radius=20000000',
            key: 'key=AIzaSyC-Lgj5QeFDBcaTcSeczKlhObV54M6Fb2w',
            type: 'types=geocode',
        };
        
        var data = {};

        $.getJSON("../data/ReturnNetworkData_F2.json", function (json) {
            var CountryList = {};
            data = json;

            if (json) {
                json.map(function (item) {
                    if (!CountryList.hasOwnProperty(item["Loc_City"])) {
                        CountryList[item["Loc_City"]] = 1;
                    } else {
                        CountryList[item["Loc_City"]] += 1;
                    }
                    return CountryList;
                });
            }
            // console.log(Object.keys(CountryList)); // this will show the info it in firebug console
            console.log(CountryList);
            //            geojsonData = Object.keys(CountryList);
            
        });
        
        function generate(){
            geojsonData = buildGeoJson(data);
            console.log(geojsonData);

            for (var i = 0; i < geojsonData.features.length; i++) {
                find(geojsonData.features[i], i);
            }
            console.log("all down");
            //            console.log(geojsonData);
            saveJson(geojsonData);
        }

        function buildGeoJson(properties) {
            var geojson = {};
            var geojsonFeatures = [];

            geojson["type"] = "FeatureCollection";

            for (var i in properties) {
                geojsonFeatures.push({
                    "type": "Feature",
                    "properties": properties[i],
                    "geometry": {
                        "type": "Point",
                        "coordinates": (function () {
                            var coor = properties[i]["Loc_Lat_Lon"].split(", ");
                            return [coor[0], coor[1]];
                        })()
                    }
                });
            }
            geojson["features"] = geojsonFeatures;

            return geojson;
        }

        function find(featureItem, index) {
            var xhr = new XMLHttpRequest();
            //var randomAddress = geojsonData[Math.ceil(Math.random() * 118)].Country;

            geocodeKey.address = featureItem.properties["Loc_City"];

            //xhr.open("GET", "https://maps.googleapis.com/maps/api/geocode/json?address=Mountain+View,+CA&key=AIzaSyC-Lgj5QeFDBcaTcSeczKlhObV54M6Fb2w", false);
            //xhr.open("GET", geocodeKey.url + geocodeKey.address + "&" + geocodeKey.nobias + "&" + geocodeKey.key , false);
            var geoURL = geocodeKey.url + geocodeKey.address + "&" + geocodeKey.nobias + "&" + geocodeKey.type + "&" + geocodeKey.key;

            if (geoURL) {
                var currentLoc;
                xhr.open("GET", geoURL, false);
                xhr.send();

                currentLoc = printResult(xhr);

                if (currentLoc !== "XHR Error") {
                    featureItem.geometry.coordinates[0] = currentLoc.lat;
                    featureItem.geometry.coordinates[1] = currentLoc.lng;
                    console.log(geocodeKey.address);
                }else {
                    console.error("error address");
                }

            }
        }

        function printResult(xhr) {
            if (xhr.status === 200) {
                var responseText = xhr.responseText;
                var responseObj = JSON.parse(responseText);

                return responseObj.status == "OK" ?
                    responseObj.results[0].geometry.location : "Result: " + responseObj.status;
            } else {
                return "XHR Error";
            }
        }

        function saveJson(JsonExport) {
            //Get the file contents
            //            var txtFile = "../data/test.txt";
            //            var file = new File(txtFile);
            var str = JSON.stringify(JsonExport);

            //Save the file contents as a DataURI
            var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(str);

            //Write it as the href for the link
            var link = document.getElementById('link').href = dataUri;
        }

        //        function editJson(JsonExport) {
        //            var txtFile = "../data/test.txt";
        //            var file = new File(txtFile, "write");
        //            var str = JSON.stringify(JsonExport);
        //
        //            log("opening file...");
        //            file.open();
        //            log("writing file..");
        //            file.writeline(str);
        //            file.close();
        //        }

    </script>
</head>

<body>
    <div class="main-content">
        <div>
            # Search for AJAX Call #
            <label for="carMake">Address:</label>
            <input type="text" id="carMake" size="5" />
            <br />
            <input type="button" value="Generate" onclick="generate();" />
            <br>
            <input type="button" value="FIND" onclick="find();" />
            <div id="grid">
            </div>
            <div>
                <a href="#" id="link" download="example.json">Download as JSON</a>
            </div>
        </div>
    </div>
</body>

</html>
